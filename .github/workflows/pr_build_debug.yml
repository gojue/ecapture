name: PR Build (Debug)
on:
  pull_request:
    branches: [ master, main ]
    types: [ opened, synchronize, reopened ]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-debug-artifacts:
    runs-on: ubuntu-22.04
    name: Build Debug Artifacts
    strategy:
      matrix:
        file:
          - ecapture-v0.0.0-pr-${{ github.event.number || 'dev' }}-debug-android-arm64.tar.gz
          - ecapture-v0.0.0-pr-${{ github.event.number || 'dev' }}-debug-android-amd64.tar.gz
          - ecapture-v0.0.0-pr-${{ github.event.number || 'dev' }}-debug-linux-arm64.tar.gz
          - ecapture-v0.0.0-pr-${{ github.event.number || 'dev' }}-debug-linux-amd64.tar.gz
          - ecapture_v0.0.0-pr-${{ github.event.number || 'dev' }}-debug_linux_arm64.deb
          - ecapture_v0.0.0-pr-${{ github.event.number || 'dev' }}-debug_linux_amd64.deb
    steps:
      - uses: actions/setup-go@v5
        with:
          go-version: '1.24.3'

      - name: Install Compilers
        run: |
          sudo apt-get update
          sudo apt-get install --yes \
            build-essential \
            pkgconf \
            libelf-dev \
            llvm-14 \
            clang-14 \
            linux-tools-common \
            linux-tools-generic \
            gcc \
            gcc-aarch64-linux-gnu \
            linux-source
          for tool in "clang" "llc" "llvm-strip"
          do
            sudo rm -f /usr/bin/$tool
            sudo ln -s /usr/bin/$tool-14 /usr/bin/$tool
          done
          cd /usr/src
          source_file=$(find . -maxdepth 1 -name "*linux-source*.tar.bz2")
          source_dir=$(echo "$source_file" | sed 's/\.tar\.bz2//g')
          sudo tar -xf $source_file
          cd $source_dir
          test -f .config || sudo make oldconfig
          sudo make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- prepare V=0
        shell: bash

      - uses: actions/checkout@v4
        with:
          submodules: 'recursive'
          fetch-depth: 0

      - name: Build Debug amd64
        run: |
          make clean
          make env
          DEBUG=1 make -f builder/Makefile.release release SNAPSHOT_VERSION=v0.0.0-pr-${{ github.event.number || 'dev' }}-debug
          cp bin/ecapture-*.tar.gz dist/
          cp bin/ecapture*.deb dist/

      - name: Build Debug arm64
        run: |
          make clean
          make env
          DEBUG=1 CROSS_ARCH=arm64 make -f builder/Makefile.release release SNAPSHOT_VERSION=v0.0.0-pr-${{ github.event.number || 'dev' }}-debug
          cp bin/ecapture-*.tar.gz dist/
          cp bin/ecapture*.deb dist/

      - name: Upload Debug Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.file }}
          path: dist/${{ matrix.file }}

          retention-days: 7

      - name: List Built Artifacts
        run: |
          echo "Built debug artifacts:"
          ls -la dist/
          echo "Artifact sizes:"
          du -h dist/*

      - name: Comment PR with Download Links
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const runId = context.runId;
            const prNumber = context.payload.pull_request.number;
            
            github.rest.issues.createComment({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `üîß **Debug Build Complete**

              üì¶ Download Links:
              - [PR ${prNumber} Debug Binary](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${runId})

              ‚è∞ Files will be retained for 7 days, please download and test promptly.`
            });